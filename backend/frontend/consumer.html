<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Consumer View — HerbTrace</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f1f8e9; margin: 0; }
    nav { background: #2E8B57; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    .nav-container .logo { font-weight: bold; font-size: 1.5em; }
    .nav-links { list-style: none; display: flex; gap: 15px; margin: 0; }
    .nav-links li a { color: white; text-decoration: none; font-weight: 500; }
    .nav-links li a:hover { text-decoration: underline; }

    .container { max-width: 900px; margin: 30px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    h2 { color: #2E8B57; text-align: center; margin-bottom: 25px; }
    .form-group { margin-bottom: 15px; }
    .form-group input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; box-sizing: border-box; }
    button { padding: 12px 20px; background: #2E8B57; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    button:hover { background: #246b46; }
    .batch-card { border-left: 4px solid #2E8B57; padding: 15px; margin: 15px 0; border-radius: 6px; background: #f7f9fb; }
    .muted { color: #666; font-size: 0.9em; }
    a.link { color: #2E8B57; text-decoration: none; }
    a.link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <div class="logo">HerbTrace</div>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="consumer.html">Consumer</a></li>
        <li><a href="qr.html">QR Generator</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <h2>Consumer View</h2>
    <p style="text-align:center; color:#555;">Enter a batch ID to view its full journey from farm to lab.</p>

    <div class="form-group">
      <input type="text" id="batchIdInput" placeholder="Enter Batch ID">
    </div>
    <button onclick="viewBatch()">View Batch</button>

    <div id="batchDetails" style="margin-top: 20px;"></div>
  </div>

  <script>
    async function viewBatch() {
      const batchId = document.getElementById('batchIdInput').value.trim();
      const container = document.getElementById('batchDetails');
      container.innerHTML = '';

      if (!batchId) return alert('Please enter a Batch ID');

      const res = await fetch(`/api/consumer/view?batchId=${batchId}`);
      const data = await res.json();

      if (data.ok && data.events.length > 0) {
        data.events.forEach(e => {
          const div = document.createElement('div');
          div.className = 'batch-card';

          if (e.type === 'collection') {
            div.innerHTML = `<strong>Collection</strong> — <span class="muted">by ${e.collector || e.farmer || 'unknown'} at ${new Date(e.timestamp).toLocaleString()}</span><br>
                             Species: ${e.species} | Quality: ${e.quality}<br>
                             ${e.lat && e.long ? `Location: (${e.lat}, ${e.long})<br>` : ''}
                             ${e.imageLink ? `Image: <a class="link" target="_blank" href="${e.imageLink}">View</a><br>` : ''}
                             Status: ${e.status || 'N/A'}`;
          } else if (e.type === 'processing') {
            div.innerHTML = `<strong>Processing</strong> — <span class="muted">by ${e.processor || 'processor'} at ${new Date(e.timestamp).toLocaleString()}</span><br>
                             Facility: ${e.facility} (${e.facilityLocation || 'N/A'})<br>
                             Manager: ${e.managerName}<br>
                             Process Type: ${e.processType}<br>
                             Status: ${e.status || 'N/A'}`;
          } else if (e.type === 'quality') {
            div.innerHTML = `<strong>Lab Test</strong> — <span class="muted">by ${e.lab || e.labName || 'lab'} at ${new Date(e.timestamp).toLocaleString()}</span><br>
                             Lab: ${e.labName || e.lab}<br>
                             Manager: ${e.labManagerName || 'N/A'}<br>
                             Result: ${e.resultStatus}<br>
                             ${e.ipfsLink ? `Report: <a class="link" target="_blank" href="${e.ipfsLink}">View on IPFS</a><br>` : ''}
                             Status: ${e.status || 'N/A'}`;
          }

          container.appendChild(div);
        });
      } else {
        container.innerHTML = `<p class="muted" style="text-align:center;">No records found for Batch ID "${batchId}".</p>`;
      }
    }
  </script>
</body>
</html>
